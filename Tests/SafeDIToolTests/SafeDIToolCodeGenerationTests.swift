// Distributed under the MIT License
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

import SafeDICore
import XCTest

@testable import SafeDITool

final class SafeDIToolCodeGenerationTests: XCTestCase {
    // MARK: XCTestCase

    override func setUpWithError() throws {
        try super.setUpWithError()

        filesToDelete = [URL]()
    }

    override func tearDownWithError() throws {
        try super.tearDownWithError()

        for fileToDelete in filesToDelete {
            try FileManager.default.removeItem(at: fileToDelete)
        }
    }

    // MARK: Code Generation Tests

    @MainActor
    func test_run_successfullyGeneratesOutputFileWhenNoCodeInput() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            // No root @Instantiable-decorated types found, or root types already had a `public init()` method.
            """
        )
    }

    @MainActor
    func test_run_doesNotWriteExtensionIfRootAlreadyHasEmptyInitializer() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                public protocol NetworkService {}

                @Instantiable(isRoot: true, fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    let urlSession: URLSession = .shared
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            // No root @Instantiable-decorated types found, or root types already had a `public init()` method.
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootIsClass() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}

                    let urlSession: URLSession = .shared
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let networkService: NetworkService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    self.init(networkService: networkService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootIsActor() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import class Foundation.URLSession

                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}

                    let urlSession: URLSession = .shared
                }
                """,
                """
                @Instantiable(isRoot: true)
                public actor Root {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let networkService: NetworkService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import class Foundation.URLSession
            #endif

            extension Root {
                public init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    self.init(networkService: networkService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootIsStruct() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}

                    let urlSession: URLSession = .shared
                }
                """,
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let networkService: NetworkService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    self.init(networkService: networkService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenMultipleRootsExist() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}

                    let urlSession: URLSession = .shared
                }
                """,
                """
                @Instantiable(isRoot: true)
                public struct Root1 {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let networkService: NetworkService
                }
                """,
                """
                @Instantiable(isRoot: true)
                public struct Root2 {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let networkService: NetworkService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root1 {
                public init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    self.init(networkService: networkService)
                }
            }

            extension Root2 {
                public init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    self.init(networkService: networkService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootHasAnAnyProperty() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(userService: any UserService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated private let userService: any UserService
                }
                """,
                """
                import Foundation

                public protocol UserService {
                    var userName: String? { get set }
                }

                @Instantiable(fulfillingAdditionalTypes: [UserService.self])
                public final class DefaultUserService: UserService {
                    public init() {}

                    public var userName: String?
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public init() {
                    let userService: any UserService = DefaultUserService()
                    self.init(userService: userService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootHasAnAnyPropertyFulfilledByAnyAdditionalType() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public protocol SomeProtocol<SomeAssociatedType> {
                    associatedtype SomeAssociatedType
                }
                """,
                """
                @Instantiable(fulfillingAdditionalTypes: [(any SomeProtocol<OtherType>).self])
                public final class SomeClass: SomeProtocol {
                    public init() {}

                    public typealias SomeAssociatedType = OtherType
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class SomeInstantiated: Instantiable {
                    public init(someClass: any SomeProtocol<OtherType>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated private let someClass: any SomeProtocol<OtherType>
                }
                """,
                """
                public final class OtherType {}
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension SomeInstantiated {
                public convenience init() {
                    let someClass: any SomeProtocol<OtherType> = SomeClass()
                    self.init(someClass: someClass)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootHasAnOptionalProperty() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(userService: UserService?) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated private let userService: UserService?
                }
                """,
                """
                import Foundation

                public protocol UserService {
                    var userName: String? { get set }
                }

                @Instantiable(fulfillingAdditionalTypes: [UserService.self])
                public final class DefaultUserService: UserService {
                    public init() {}

                    public var userName: String?
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public init() {
                    let userService: UserService? = DefaultUserService()
                    self.init(userService: userService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootHasMultipleLayers() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User()
                    }

                    @Received let networkService: NetworkService
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: ErasedInstantiator<User, UIViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        derivedValue = false
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let networkService: NetworkService

                    @Instantiated let authService: AuthService

                    @Instantiated(fulfilledByType: "LoggedInViewController") let loggedInViewControllerBuilder: ErasedInstantiator<User, UIViewController>

                    private let derivedValue: Bool

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(user)
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(user: User, networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let user: User

                    @Received let networkService: NetworkService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(user: User) -> LoggedInViewController {
                        LoggedInViewController(user: user, networkService: networkService)
                    }
                    let loggedInViewControllerBuilder = ErasedInstantiator<User, UIViewController> {
                        __safeDI_loggedInViewControllerBuilder(user: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesThatUtilizesSingleForwardedPropertyInSubBuilders() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User()
                    }

                    @Received let networkService: NetworkService
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: Instantiator<LoggedInViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        derivedValue = false
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let networkService: NetworkService

                    @Instantiated let authService: AuthService

                    @Instantiated let loggedInViewControllerBuilder: Instantiator<LoggedInViewController>

                    private let derivedValue: Bool

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(user)
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                @Instantiable
                public final class UserService {
                    public init(user: User) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let user: User
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(user: User, networkService: NetworkService, userService: UserService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let user: User

                    @Received let networkService: NetworkService
                    @Instantiated let userService: UserService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(user: User) -> LoggedInViewController {
                        let userService = UserService(user: user)
                        return LoggedInViewController(user: user, networkService: networkService, userService: userService)
                    }
                    let loggedInViewControllerBuilder = Instantiator<LoggedInViewController> {
                        __safeDI_loggedInViewControllerBuilder(user: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesThatUtilizesSingleEscapingForwardedProperty() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable
                public final class NetworkService: Instantiable {
                    public init(fetchAuthToken: @escaping () -> Void) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let fetchAuthToken: () -> Void
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(networkServiceBuilder: Instantiator<NetworkService>) {
                        self.networkServiceBuilder = networkServiceBuilder
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let networkServiceBuilder: Instantiator<NetworkService>
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    func __safeDI_networkServiceBuilder(fetchAuthToken: @escaping () -> Void) -> NetworkService {
                        NetworkService(fetchAuthToken: fetchAuthToken)
                    }
                    let networkServiceBuilder = Instantiator<NetworkService> {
                        __safeDI_networkServiceBuilder(fetchAuthToken: $0)
                    }
                    self.init(networkServiceBuilder: networkServiceBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesThatUtilizeMultipleForwardedPropertiesInSubBuilders() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {
                    public var id: String
                    public var name: String
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User()
                    }

                    @Received let networkService: NetworkService
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: ErasedInstantiator<(userID: String, userName: String), UIViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        derivedValue = false
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let networkService: NetworkService

                    @Instantiated let authService: AuthService

                    @Instantiated(fulfilledByType: "LoggedInViewController") let loggedInViewControllerBuilder: ErasedInstantiator<(userID: String, userName: String), UIViewController>

                    private let derivedValue: Bool

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate((userID: user.id, userName: user.name))
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                @Instantiable
                public final class UserService {
                    public init(userName: String, userID: String) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let userName: String

                    @Received let userID: String
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(userName: String, userID: String, networkService: NetworkService, userService: UserService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let userName: String

                    @Forwarded private let userID: String

                    @Received let networkService: NetworkService

                    @Instantiated let userService: UserService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(userID: String, userName: String) -> LoggedInViewController {
                        let userService = UserService(userName: userName, userID: userID)
                        return LoggedInViewController(userName: userName, userID: userID, networkService: networkService, userService: userService)
                    }
                    let loggedInViewControllerBuilder = ErasedInstantiator<(userID: String, userName: String), UIViewController> {
                        __safeDI_loggedInViewControllerBuilder(userID: $0.userID, userName: $0.userName)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesThatUtilizeMultipleForwardedPropertiesAndDependencyInversionInSubBuilders() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {
                    public var id: String
                    public var name: String
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User()
                    }

                    @Received let networkService: NetworkService
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: ErasedInstantiator<LoggedInViewController.ForwardedProperties, UIViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        derivedValue = false
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let networkService: NetworkService

                    @Instantiated let authService: AuthService

                    @Instantiated(fulfilledByType: "LoggedInViewController") let loggedInViewControllerBuilder: ErasedInstantiator<LoggedInViewController.ForwardedProperties, UIViewController>

                    private let derivedValue: Bool

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate((userID: user.id, userName: user.name))
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                @Instantiable
                public final class UserService {
                    public init(userName: String, userID: String) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let userName: String

                    @Received let userID: String
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(userName: String, userID: String, networkService: NetworkService, userService: UserService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let userName: String

                    @Forwarded private let userID: String

                    @Received let networkService: NetworkService

                    @Instantiated let userService: UserService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(userID: String, userName: String) -> LoggedInViewController {
                        let userService = UserService(userName: userName, userID: userID)
                        return LoggedInViewController(userName: userName, userID: userID, networkService: networkService, userService: userService)
                    }
                    let loggedInViewControllerBuilder = ErasedInstantiator<LoggedInViewController.ForwardedProperties, UIViewController> {
                        __safeDI_loggedInViewControllerBuilder(userID: $0.userID, userName: $0.userName)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesThatUtilizesDependencyInversionOfExistentialTypeInSubBuilder() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import SwiftUI

                @Instantiable(isRoot: true)
                public struct RootView: View {
                    public init(splashScreenView: AnyView) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public var view: some View {
                        splashScreenView
                    }

                    @Instantiated(fulfilledByType: "SplashScreenView", erasedToConcreteExistential: true) private let splashScreenView: AnyView
                }
                """,
                """
                import SwiftUI

                @Instantiable
                public struct SplashScreenView: View {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(SwiftUI)
            import SwiftUI
            #endif

            extension RootView {
                public init() {
                    let splashScreenView = AnyView(SplashScreenView())
                    self.init(splashScreenView: splashScreenView)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesThatUtilizesLazyDependencyInversionOfExistentialTypeInSubBuilder() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import SwiftUI

                @Instantiable(isRoot: true)
                public struct RootView: View {
                    public init(splashScreenViewBuilder: ErasedInstantiator<(), AnyView>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public var view: some View {
                        splashScreenViewBuilder.instantaite()
                    }

                    @Instantiated(fulfilledByType: "SplashScreenView", erasedToConcreteExistential: true) private let splashScreenViewBuilder: ErasedInstantiator<(), AnyView>
                }
                """,
                """
                import SwiftUI

                @Instantiable
                public struct SplashScreenView: View {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(SwiftUI)
            import SwiftUI
            #endif

            extension RootView {
                public init() {
                    func __safeDI_splashScreenViewBuilder() -> SplashScreenView {
                        SplashScreenView()
                    }
                    let splashScreenViewBuilder = ErasedInstantiator<(), AnyView> {
                        AnyView(__safeDI_splashScreenViewBuilder())
                    }
                    self.init(splashScreenViewBuilder: splashScreenViewBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesThatUtilizePropertiesNotDirectlyProvidedByParent() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User()
                    }

                    @Received let networkService: NetworkService
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: Instantiator<LoggedInViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        derivedValue = false
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let authService: AuthService

                    @Instantiated let networkService: NetworkService

                    @Instantiated let loggedInViewControllerBuilder: Instantiator<LoggedInViewController>

                    private let derivedValue: Bool

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(user)
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                @Instantiable
                public final class UserService {
                    public init(user: User, networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let user: User

                    @Received private let networkService: NetworkService
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(user: User, userService: UserService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let user: User

                    @Instantiated let userService: UserService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(user: User) -> LoggedInViewController {
                        let userService = UserService(user: user, networkService: networkService)
                        return LoggedInViewController(user: user, userService: userService)
                    }
                    let loggedInViewControllerBuilder = Instantiator<LoggedInViewController> {
                        __safeDI_loggedInViewControllerBuilder(user: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithMultipleLayersOfInstantiators() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User()
                    }

                    @Received let networkService: NetworkService                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: Instantiator<LoggedInViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        derivedValue = false
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let authService: AuthService

                    @Instantiated let networkService: NetworkService

                    @Instantiated let loggedInViewControllerBuilder: Instantiator<LoggedInViewController>

                    private let derivedValue: Bool

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(user)
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                @Instantiable
                public final class UserService {
                    public init(user: User, networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let user: User

                    @Received private let networkService: NetworkService
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(user: User, userServiceInstantiator: Instantiator<UserService>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let user: User

                    @Instantiated let userServiceInstantiator: Instantiator<UserService>
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(user: User) -> LoggedInViewController {
                        func __safeDI_userServiceInstantiator() -> UserService {
                            UserService(user: user, networkService: networkService)
                        }
                        let userServiceInstantiator = Instantiator<UserService>(__safeDI_userServiceInstantiator)
                        return LoggedInViewController(user: user, userServiceInstantiator: userServiceInstantiator)
                    }
                    let loggedInViewControllerBuilder = Instantiator<LoggedInViewController> {
                        __safeDI_loggedInViewControllerBuilder(user: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertyWithMissingInstantiableInitializer() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
                """
                @Instantiable
                public final class Child {
                    // This Child is incorrectly configured! It is missing the required initializer.

                    @Instantiated let grandchild: Grandchild

                    let uninitializedProperty: Int
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let grandchild = Grandchild()
                        return Child(/* @Instantiable type is incorrectly configured. Fix errors from @Instantiable macro to fix this error. */)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertyWithInitializerWithDefaultArgumentForNonInjectedProperty() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init(grandchild: Grandchild, nonInjectedProperty: Int = 5) {
                        self.grandchild = grandchild
                        self.nonInjectedProperty = nonInjectedProperty
                    }

                    @Instantiated let grandchild: Grandchild

                    let nonInjectedProperty: Int
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let grandchild = Grandchild()
                        return Child(grandchild: grandchild)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertyWithNotPublicInstantiableInitializer() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
                """
                @Instantiable
                final class Child {
                    public init(grandchild: Grandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchild: Grandchild
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let grandchild = Grandchild()
                        return Child(grandchild: grandchild)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesNonPublicProperty() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
                """
                @Instantiable
                final class Child {
                    public init(grandchild: Grandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchild: Grandchild
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let grandchild = Grandchild()
                        return Child(grandchild: grandchild)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithMultipleTreesThatReceiveTheSameProperty() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(childA: ChildA, childB: ChildB, greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let childA: ChildA
                    @Instantiated let childB: ChildB
                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class ChildA {
                    public init(grandchildAA: GrandchildAA, grandchildAB: GrandchildAB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildAA: GrandchildAA
                    @Instantiated let grandchildAB: GrandchildAB
                }
                """,
                """
                @Instantiable
                public final class GrandchildAA {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GrandchildAB {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class ChildB {
                    public init(grandchildBA: GrandchildBA, grandchildBB: GrandchildBB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildBA: GrandchildBA
                    @Instantiated let grandchildBB: GrandchildBB
                }
                """,
                """
                @Instantiable
                public final class GrandchildBA {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GrandchildBB {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchild {
                    public init() {}
                }
                """,

            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    let greatGrandchild = GreatGrandchild()
                    func __safeDI_childA() -> ChildA {
                        let grandchildAA = GrandchildAA(greatGrandchild: greatGrandchild)
                        let grandchildAB = GrandchildAB(greatGrandchild: greatGrandchild)
                        return ChildA(grandchildAA: grandchildAA, grandchildAB: grandchildAB)
                    }
                    let childA: ChildA = __safeDI_childA()
                    func __safeDI_childB() -> ChildB {
                        let grandchildBA = GrandchildBA(greatGrandchild: greatGrandchild)
                        let grandchildBB = GrandchildBB(greatGrandchild: greatGrandchild)
                        return ChildB(grandchildBA: grandchildBA, grandchildBB: grandchildBB)
                    }
                    let childB: ChildB = __safeDI_childB()
                    self.init(childA: childA, childB: childB, greatGrandchild: greatGrandchild)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithMultipleTreesThatInstantiateTheSamePropertyInMiddleLevel() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(childA: ChildA, childB: ChildB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let childA: ChildA
                    @Instantiated let childB: ChildB
                }
                """,
                """
                @Instantiable
                public final class ChildA {
                    public init(grandchildAA: GrandchildAA, grandchildAB: GrandchildAB, greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildAA: GrandchildAA
                    @Instantiated let grandchildAB: GrandchildAB
                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GrandchildAA {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GrandchildAB {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class ChildB {
                    public init(grandchildBA: GrandchildBA, grandchildBB: GrandchildBB, greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildBA: GrandchildBA
                    @Instantiated let grandchildBB: GrandchildBB
                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GrandchildBA {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GrandchildBB {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchild {
                    public init() {}
                }
                """,

            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_childA() -> ChildA {
                        let greatGrandchild = GreatGrandchild()
                        let grandchildAA = GrandchildAA(greatGrandchild: greatGrandchild)
                        let grandchildAB = GrandchildAB(greatGrandchild: greatGrandchild)
                        return ChildA(grandchildAA: grandchildAA, grandchildAB: grandchildAB, greatGrandchild: greatGrandchild)
                    }
                    let childA: ChildA = __safeDI_childA()
                    func __safeDI_childB() -> ChildB {
                        let greatGrandchild = GreatGrandchild()
                        let grandchildBA = GrandchildBA(greatGrandchild: greatGrandchild)
                        let grandchildBB = GrandchildBB(greatGrandchild: greatGrandchild)
                        return ChildB(grandchildBA: grandchildBA, grandchildBB: grandchildBB, greatGrandchild: greatGrandchild)
                    }
                    let childB: ChildB = __safeDI_childB()
                    self.init(childA: childA, childB: childB)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithSingleTreeThatInstantiatesTheSamePropertyAtMultipleLevels() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
                """
                @Instantiable
                public final class Recreated {
                    public init() {}
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init(grandchild: Grandchild, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchild: Grandchild
                    @Instantiated let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init(greatGrandchild: GreatGrandchild, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                    @Instantiated let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchild {
                    public init(recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let recreated: Recreated
                }
                """,

            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        func __safeDI_grandchild() -> Grandchild {
                            let recreated = Recreated()
                            let greatGrandchild = GreatGrandchild(recreated: recreated)
                            return Grandchild(greatGrandchild: greatGrandchild, recreated: recreated)
                        }
                        let grandchild: Grandchild = __safeDI_grandchild()
                        let recreated = Recreated()
                        return Child(grandchild: grandchild, recreated: recreated)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithSingleTreeThatInstantiatesAReceivedPropertyBelowWhereItIsReceived() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                    @Instantiated let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class Recreated {
                    public init() {}
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init(grandchild: Grandchild, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchild: Grandchild
                    @Received let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchild {
                    public init(recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let recreated: Recreated
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    let recreated = Recreated()
                    func __safeDI_child() -> Child {
                        func __safeDI_grandchild() -> Grandchild {
                            func __safeDI_greatGrandchild() -> GreatGrandchild {
                                let recreated = Recreated()
                                return GreatGrandchild(recreated: recreated)
                            }
                            let greatGrandchild: GreatGrandchild = __safeDI_greatGrandchild()
                            return Grandchild(greatGrandchild: greatGrandchild)
                        }
                        let grandchild: Grandchild = __safeDI_grandchild()
                        return Child(grandchild: grandchild, recreated: recreated)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child, recreated: recreated)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithSingleTreeThatInstantiatesAReceivedPropertyMultipleLevelsBelowWhereItIsFirstReceived() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                    @Instantiated let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class Recreated {
                    public init() {}
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init(grandchild: Grandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchild: Grandchild
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchild {
                    public init(greatGreatGrandchild: GreatGreatGrandchild, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGreatGrandchild: GreatGreatGrandchild
                    @Received let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class GreatGreatGrandchild {
                    public init(recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let recreated: Recreated
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    let recreated = Recreated()
                    func __safeDI_child() -> Child {
                        func __safeDI_grandchild() -> Grandchild {
                            func __safeDI_greatGrandchild() -> GreatGrandchild {
                                func __safeDI_greatGreatGrandchild() -> GreatGreatGrandchild {
                                    let recreated = Recreated()
                                    return GreatGreatGrandchild(recreated: recreated)
                                }
                                let greatGreatGrandchild: GreatGreatGrandchild = __safeDI_greatGreatGrandchild()
                                return GreatGrandchild(greatGreatGrandchild: greatGreatGrandchild, recreated: recreated)
                            }
                            let greatGrandchild: GreatGrandchild = __safeDI_greatGrandchild()
                            return Grandchild(greatGrandchild: greatGrandchild)
                        }
                        let grandchild: Grandchild = __safeDI_grandchild()
                        return Child(grandchild: grandchild)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child, recreated: recreated)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithSingleTreeThatInstantiatesAPropertyReceivedInOneChildBranchMultipleLevelsBelowWhereItIsFirstReceived() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
                """
                @Instantiable
                public final class Recreated: Sendable {
                    public init() {}
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init(grandchild: Grandchild, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchild: Grandchild
                    @Instantiated let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init(greatGrandchildA: GreatGrandchildA, greatGrandchildB: GreatGrandchildB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchildA: GreatGrandchildA
                    @Instantiated let greatGrandchildB: GreatGrandchildB
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchildA {
                    public init(greatGreatGrandchild: GreatGreatGrandchild, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGreatGrandchild: GreatGreatGrandchild
                    @Received let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchildB {
                    public init(greatGreatGrandchild: GreatGreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGreatGrandchild: GreatGreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GreatGreatGrandchild {
                    public init(recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let recreated: Recreated
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let recreated = Recreated()
                        func __safeDI_grandchild() -> Grandchild {
                            func __safeDI_greatGrandchildA() -> GreatGrandchildA {
                                func __safeDI_greatGreatGrandchild() -> GreatGreatGrandchild {
                                    let recreated = Recreated()
                                    return GreatGreatGrandchild(recreated: recreated)
                                }
                                let greatGreatGrandchild: GreatGreatGrandchild = __safeDI_greatGreatGrandchild()
                                return GreatGrandchildA(greatGreatGrandchild: greatGreatGrandchild, recreated: recreated)
                            }
                            let greatGrandchildA: GreatGrandchildA = __safeDI_greatGrandchildA()
                            func __safeDI_greatGrandchildB() -> GreatGrandchildB {
                                func __safeDI_greatGreatGrandchild() -> GreatGreatGrandchild {
                                    let recreated = Recreated()
                                    return GreatGreatGrandchild(recreated: recreated)
                                }
                                let greatGreatGrandchild: GreatGreatGrandchild = __safeDI_greatGreatGrandchild()
                                return GreatGrandchildB(greatGreatGrandchild: greatGreatGrandchild)
                            }
                            let greatGrandchildB: GreatGrandchildB = __safeDI_greatGrandchildB()
                            return Grandchild(greatGrandchildA: greatGrandchildA, greatGrandchildB: greatGrandchildB)
                        }
                        let grandchild: Grandchild = __safeDI_grandchild()
                        return Child(grandchild: grandchild, recreated: recreated)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesAPropertyForwardedByAChild_doesNotRequirePuttingInstantiatedPropertyBeforeErasedInstantiator() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(childABuilder: SendableErasedInstantiator<Recreated, ChildAProtocol>, childB: ChildB, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated(fulfilledByType: "ChildA") let childABuilder: SendableErasedInstantiator<Recreated, ChildAProtocol>
                    @Instantiated let childB: ChildB
                    @Instantiated let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class Recreated {
                    public init() {}
                }
                """,
                """
                public protocol ChildAProtocol: Sendable {}
                @Instantiable
                public final class ChildA: ChildAProtocol {
                    public init(grandchildA: GrandchildA, grandchildB: GrandchildB, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildA: GrandchildA
                    @Instantiated let grandchildB: GrandchildB
                    @Forwarded let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class ChildB {
                    public init(grandchildA: GrandchildA, grandchildB: GrandchildB, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildA: GrandchildA
                    @Instantiated let grandchildB: GrandchildB
                    @Received let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class GrandchildA {
                    public init(greatGrandchild: GreatGrandchild, recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                    @Instantiated let recreated: Recreated
                }
                """,
                """
                @Instantiable
                public final class GrandchildB {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchild {
                    public init(recreated: Recreated) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let recreated: Recreated
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    @Sendable func __safeDI_childABuilder(recreated: Recreated) -> ChildA {
                        func __safeDI_grandchildA() -> GrandchildA {
                            let recreated = Recreated()
                            let greatGrandchild = GreatGrandchild(recreated: recreated)
                            return GrandchildA(greatGrandchild: greatGrandchild, recreated: recreated)
                        }
                        let grandchildA: GrandchildA = __safeDI_grandchildA()
                        func __safeDI_grandchildB() -> GrandchildB {
                            let greatGrandchild = GreatGrandchild(recreated: recreated)
                            return GrandchildB(greatGrandchild: greatGrandchild)
                        }
                        let grandchildB: GrandchildB = __safeDI_grandchildB()
                        return ChildA(grandchildA: grandchildA, grandchildB: grandchildB, recreated: recreated)
                    }
                    let childABuilder = SendableErasedInstantiator<Recreated, ChildAProtocol> {
                        __safeDI_childABuilder(recreated: $0)
                    }
                    let recreated = Recreated()
                    func __safeDI_childB() -> ChildB {
                        func __safeDI_grandchildA() -> GrandchildA {
                            let recreated = Recreated()
                            let greatGrandchild = GreatGrandchild(recreated: recreated)
                            return GrandchildA(greatGrandchild: greatGrandchild, recreated: recreated)
                        }
                        let grandchildA: GrandchildA = __safeDI_grandchildA()
                        func __safeDI_grandchildB() -> GrandchildB {
                            let greatGrandchild = GreatGrandchild(recreated: recreated)
                            return GrandchildB(greatGrandchild: greatGrandchild)
                        }
                        let grandchildB: GrandchildB = __safeDI_grandchildB()
                        return ChildB(grandchildA: grandchildA, grandchildB: grandchildB, recreated: recreated)
                    }
                    let childB: ChildB = __safeDI_childB()
                    self.init(childABuilder: childABuilder, childB: childB, recreated: recreated)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithMultipleTreesThatInstantiateTheSamePropertyMultipleLayersDeep() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(childA: ChildA, childB: ChildB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let childA: ChildA
                    @Instantiated let childB: ChildB
                }
                """,
                """
                @Instantiable
                public final class ChildA {
                    public init(grandchildAA: GrandchildAA, grandchildAB: GrandchildAB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildAA: GrandchildAA
                    @Instantiated let grandchildAB: GrandchildAB
                }
                """,
                """
                @Instantiable
                public final class GrandchildAA {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GrandchildAB {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class ChildB {
                    public init(grandchildBA: GrandchildBA, grandchildBB: GrandchildBB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildBA: GrandchildBA
                    @Instantiated let grandchildBB: GrandchildBB
                }
                """,
                """
                @Instantiable
                public final class GrandchildBA {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GrandchildBB {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchild {
                    public init() {}
                }
                """,

            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_childA() -> ChildA {
                        func __safeDI_grandchildAA() -> GrandchildAA {
                            let greatGrandchild = GreatGrandchild()
                            return GrandchildAA(greatGrandchild: greatGrandchild)
                        }
                        let grandchildAA: GrandchildAA = __safeDI_grandchildAA()
                        func __safeDI_grandchildAB() -> GrandchildAB {
                            let greatGrandchild = GreatGrandchild()
                            return GrandchildAB(greatGrandchild: greatGrandchild)
                        }
                        let grandchildAB: GrandchildAB = __safeDI_grandchildAB()
                        return ChildA(grandchildAA: grandchildAA, grandchildAB: grandchildAB)
                    }
                    let childA: ChildA = __safeDI_childA()
                    func __safeDI_childB() -> ChildB {
                        func __safeDI_grandchildBA() -> GrandchildBA {
                            let greatGrandchild = GreatGrandchild()
                            return GrandchildBA(greatGrandchild: greatGrandchild)
                        }
                        let grandchildBA: GrandchildBA = __safeDI_grandchildBA()
                        func __safeDI_grandchildBB() -> GrandchildBB {
                            let greatGrandchild = GreatGrandchild()
                            return GrandchildBB(greatGrandchild: greatGrandchild)
                        }
                        let grandchildBB: GrandchildBB = __safeDI_grandchildBB()
                        return ChildB(grandchildBA: grandchildBA, grandchildBB: grandchildBB)
                    }
                    let childB: ChildB = __safeDI_childB()
                    self.init(childA: childA, childB: childB)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesInstantiablePropertyWithNoArguments() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child, keyValueStore: KeyValueStore) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                    @Instantiated let keyValueStore: KeyValueStore
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init(keyValueStore: KeyValueStore) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let keyValueStore: KeyValueStore
                }
                """,
                """
                import Foundation

                public protocol KeyValueStore {}

                @Instantiable(fulfillingAdditionalTypes: [KeyValueStore.self])
                extension UserDefaults: @retroactive Instantiable, @retroactive KeyValueStore {
                    public static func instantiate() -> UserDefaults {
                        getShared()
                    }

                    private func getShared() -> UserDefaults { .standard }

                    final class NestedClass {}
                    actor NestedActor {}
                    struct NestedStruct {
                        public func instantiate() -> NestedStruct { init() }
                    }
                    typealias NestedTypealias = ()
                    private var sessionType: String { "foreground" }
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public convenience init() {
                    let keyValueStore: KeyValueStore = UserDefaults.instantiate()
                    let child = Child(keyValueStore: keyValueStore)
                    self.init(child: child, keyValueStore: keyValueStore)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesInstantiablePropertyWithArguments() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {
                    let username: String
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User(username: username)
                    }

                    @Received let networkService: NetworkService                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: ErasedInstantiator<User, UIViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        derivedValue = false
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated
                    let networkService: NetworkService

                    @Instantiated
                    let authService: AuthService

                    @Instantiated(fulfilledByType: "LoggedInViewController")
                    let loggedInViewControllerBuilder: ErasedInstantiator<User, UIViewController>

                    private let derivedValue: Bool

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(user)
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(user: User, networkService: NetworkService, keyValueStore: KeyValueStore) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let user: User

                    @Received let networkService: NetworkService
                    @Instantiated let keyValueStore: KeyValueStore
                }
                """,
                """
                import Foundation

                public protocol KeyValueStore {}

                @Instantiable(fulfillingAdditionalTypes: [KeyValueStore.self])
                extension UserDefaults: Instantiable {
                    public static func instantiate(user: User) -> UserDefaults {
                        UserDefaults(user: user)
                    }

                    convenience
                    init(user: User) {
                        self.init(suiteName: user.username)
                    }
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif
            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(user: User) -> LoggedInViewController {
                        let keyValueStore: KeyValueStore = UserDefaults.instantiate(user: user)
                        return LoggedInViewController(user: user, networkService: networkService, keyValueStore: keyValueStore)
                    }
                    let loggedInViewControllerBuilder = ErasedInstantiator<User, UIViewController> {
                        __safeDI_loggedInViewControllerBuilder(user: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootInstantiatesPropertiesWithMultipleTreesThatInstantiateTheSamePropertyAcrossMultipleModules() async throws {
        let greatGrandchildModuleOutput = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable
                public final class GreatGrandchild: Sendable {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: false,
            filesToDelete: &filesToDelete
        )

        let grandchildModuleOutput = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import GreatGrandchildModule

                @Instantiable
                public final class GrandchildAA {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                import GreatGrandchildModule

                @Instantiable
                public final class GrandchildAB {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                import GreatGrandchildModule

                @Instantiable
                public final class GrandchildBA {
                    public init(greatGrandchildInstantiator: SendableInstantiator<GreatGrandchild>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated var greatGrandchildInstantiator: SendableInstantiator<GreatGrandchild>
                }
                """,
                """
                import GreatGrandchildModule

                @Instantiable
                public final class GrandchildBB {
                    public init(greatGrandchildInstantiator: SendableInstantiator<GreatGrandchild>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated greatGrandchildInstantiator: SendableInstantiator<GreatGrandchild>
                }
                """,
            ],
            dependentModuleInfoPaths: [greatGrandchildModuleOutput.moduleInfoOutputPath],
            buildDependencyTreeOutput: false,
            filesToDelete: &filesToDelete
        )

        let childModuleOutput = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import class GrandchildModule.GrandchildAA
                import class GrandchildModule.GrandchildAB

                @MainActor
                @Instantiable
                public final class ChildA {
                    public init(grandchildAA: GrandchildAA, grandchildAB: GrandchildAB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildAA: GrandchildAA
                    @Instantiated let grandchildAB: GrandchildAB
                }
                """,
                """
                @preconcurrency import GrandchildModule

                @Instantiable
                public final class ChildB {
                    public init(grandchildBA: GrandchildBA, grandchildBB: GrandchildBB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchildBA: GrandchildBA
                    @Instantiated let grandchildBB: GrandchildBB
                }
                """,
            ],
            dependentModuleInfoPaths: [
                greatGrandchildModuleOutput.moduleInfoOutputPath,
                grandchildModuleOutput.moduleInfoOutputPath,
            ],
            buildDependencyTreeOutput: false,
            filesToDelete: &filesToDelete
        )

        let topLevelModuleOutput = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import ChildModule

                @MainActor
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(childA: ChildA, childB: ChildB) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let childA: ChildA
                    @Instantiated let childB: ChildB
                }
                """,
            ],
            dependentModuleInfoPaths: [
                greatGrandchildModuleOutput.moduleInfoOutputPath,
                grandchildModuleOutput.moduleInfoOutputPath,
                childModuleOutput.moduleInfoOutputPath,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(topLevelModuleOutput.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(ChildModule)
            import ChildModule
            #endif
            #if canImport(GrandchildModule)
            import GrandchildModule
            #endif
            #if canImport(GreatGrandchildModule)
            import GreatGrandchildModule
            #endif

            extension Root {
                public convenience init() {
                    func __safeDI_childA() -> ChildA {
                        func __safeDI_grandchildAA() -> GrandchildAA {
                            let greatGrandchild = GreatGrandchild()
                            return GrandchildAA(greatGrandchild: greatGrandchild)
                        }
                        let grandchildAA: GrandchildAA = __safeDI_grandchildAA()
                        func __safeDI_grandchildAB() -> GrandchildAB {
                            let greatGrandchild = GreatGrandchild()
                            return GrandchildAB(greatGrandchild: greatGrandchild)
                        }
                        let grandchildAB: GrandchildAB = __safeDI_grandchildAB()
                        return ChildA(grandchildAA: grandchildAA, grandchildAB: grandchildAB)
                    }
                    let childA: ChildA = __safeDI_childA()
                    func __safeDI_childB() -> ChildB {
                        func __safeDI_grandchildBA() -> GrandchildBA {
                            @Sendable func __safeDI_greatGrandchildInstantiator() -> GreatGrandchild {
                                GreatGrandchild()
                            }
                            let greatGrandchildInstantiator = SendableInstantiator<GreatGrandchild>(__safeDI_greatGrandchildInstantiator)
                            return GrandchildBA(greatGrandchildInstantiator: greatGrandchildInstantiator)
                        }
                        let grandchildBA: GrandchildBA = __safeDI_grandchildBA()
                        func __safeDI_grandchildBB() -> GrandchildBB {
                            @Sendable func __safeDI_greatGrandchildInstantiator() -> GreatGrandchild {
                                GreatGrandchild()
                            }
                            let greatGrandchildInstantiator = SendableInstantiator<GreatGrandchild>(__safeDI_greatGrandchildInstantiator)
                            return GrandchildBB(greatGrandchildInstantiator: greatGrandchildInstantiator)
                        }
                        let grandchildBB: GrandchildBB = __safeDI_grandchildBB()
                        return ChildB(grandchildBA: grandchildBA, grandchildBB: grandchildBB)
                    }
                    let childB: ChildB = __safeDI_childB()
                    self.init(childA: childA, childB: childB)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootHasReceivedAliasOfInstantiable() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(defaultUserService: DefaultUserService, userService: any UserService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated private let defaultUserService: DefaultUserService

                    @Received(fulfilledByDependencyNamed: "defaultUserService", ofType: DefaultUserService.self) private let userService: any UserService
                }
                """,
                """
                @_implementationOnly import Foundation

                public protocol UserService {
                    var userName: String? { get set }
                }

                @Instantiable(fulfillingAdditionalTypes: [UserService.self])
                public final class DefaultUserService: UserService {
                    public init() {}

                    public var userName: String?
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            @_implementationOnly import Foundation
            #endif

            extension Root {
                public init() {
                    let defaultUserService = DefaultUserService()
                    let userService: any UserService = defaultUserService
                    self.init(defaultUserService: defaultUserService, userService: userService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_successfullyGeneratesOutputFileWhenNoRootFound() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable
                public struct NotRoot {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            // No root @Instantiable-decorated types found, or root types already had a `public init()` method.
            """
        )
    }

    @MainActor
    func test_run_successfullyGeneratesOutputFileWhenIsRootIsFalse() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: false)
                public struct NotRoot {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            // No root @Instantiable-decorated types found, or root types already had a `public init()` method.
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenReceivedPropertyIsAliased() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol UserVendor {
                    var user: User { get }
                }

                public protocol UserManager: UserVendor {
                    var user: User { get set }
                }

                public final class DefaultUserManager: UserManager {
                    public init(user: User) {
                        self.user = user
                    }

                    public var user: User
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User(username: username)
                    }

                    @Received let networkService: NetworkService                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: Instantiator<LoggedInViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let authService: AuthService

                    @Instantiated let networkService: NetworkService

                    @Instantiated let loggedInViewControllerBuilder: Instantiator<LoggedInViewController>

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(UserManager(user: user))
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(userManager: UserManager, profileViewControllerBuilder: Instantiator<ProfileViewController>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let userManager: UserManager

                    @Instantiated private let profileViewControllerBuilder: Instantiator<ProfileViewController>
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class ProfileViewController: UIViewController {
                    public init(userVendor: UserVendor, editProfileViewControllerBuilder: Instantiator<EditProfileViewController>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received(fulfilledByDependencyNamed: "userManager", ofType: UserManager.self) private let userVendor: UserVendor

                    @Instantiated private let editProfileViewControllerBuilder: Instantiator<EditProfileViewController>
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class EditProfileViewController: UIViewController {
                    public init(userVendor: UserVendor, userManager: UserManager) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received private let userVendor: UserVendor
                    @Received private let userManager: UserManager
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(userManager: UserManager) -> LoggedInViewController {
                        func __safeDI_profileViewControllerBuilder() -> ProfileViewController {
                            let userVendor: UserVendor = userManager
                            func __safeDI_editProfileViewControllerBuilder() -> EditProfileViewController {
                                EditProfileViewController(userVendor: userVendor, userManager: userManager)
                            }
                            let editProfileViewControllerBuilder = Instantiator<EditProfileViewController>(__safeDI_editProfileViewControllerBuilder)
                            return ProfileViewController(userVendor: userVendor, editProfileViewControllerBuilder: editProfileViewControllerBuilder)
                        }
                        let profileViewControllerBuilder = Instantiator<ProfileViewController>(__safeDI_profileViewControllerBuilder)
                        return LoggedInViewController(userManager: userManager, profileViewControllerBuilder: profileViewControllerBuilder)
                    }
                    let loggedInViewControllerBuilder = Instantiator<LoggedInViewController> {
                        __safeDI_loggedInViewControllerBuilder(userManager: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenReceivedPropertyIsAliasedAndExistential() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(childBuilder: Instantiator<Child>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let childBuilder: Instantiator<Child>
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init(iterator: IndexingIterator<Array<Element>>, grandchildBuilder: Instantiator<Grandchild>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded let iterator: IndexingIterator<Array<Element>>
                    @Instantiated let grandchildBuilder: Instantiator<Grandchild>
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init(anyIterator: AnyIterator) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received(
                        fulfilledByDependencyNamed: "iterator",
                        ofType: IndexingIterator<Array<Element>>.self,
                        erasedToConcreteExistential: true
                    ) let anyIterator: AnyIterator
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_childBuilder(iterator: IndexingIterator<Array<Element>>) -> Child {
                        func __safeDI_grandchildBuilder() -> Grandchild {
                            let anyIterator = AnyIterator(iterator)
                            return Grandchild(anyIterator: anyIterator)
                        }
                        let grandchildBuilder = Instantiator<Grandchild>(__safeDI_grandchildBuilder)
                        return Child(iterator: iterator, grandchildBuilder: grandchildBuilder)
                    }
                    let childBuilder = Instantiator<Child> {
                        __safeDI_childBuilder(iterator: $0)
                    }
                    self.init(childBuilder: childBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenReceivedPropertyIsAliasedALevelAboveWhereItIsReceived() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol UserVendor {
                    var user: User { get }
                }

                public protocol UserManager: UserVendor {
                    var user: User { get set }
                }

                public final class DefaultUserManager: UserManager {
                    public init(user: User) {
                        self.user = user
                    }

                    public var user: User
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User(username: username)
                    }

                    @Received let networkService: NetworkService                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: Instantiator<LoggedInViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated
                    let authService: AuthService

                    @Instantiated
                    let networkService: NetworkService

                    @Instantiated
                    let loggedInViewControllerBuilder: Instantiator<LoggedInViewController>

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(UserManager(user: user))
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(userManager: UserManager, userNetworkService: NetworkService, profileViewControllerBuilder: Instantiator<ProfileViewController>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let userManager: UserManager

                    @Received(fulfilledByDependencyNamed: "networkService", ofType: NetworkService.self) private let userNetworkService: NetworkService

                    @Instantiated private let profileViewControllerBuilder: Instantiator<ProfileViewController>
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class ProfileViewController: UIViewController {
                    public init(userVendor: UserVendor, editProfileViewControllerBuilder: Instantiator<EditProfileViewController>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received(fulfilledByDependencyNamed: "userManager", ofType: UserManager.self) private let userVendor: UserVendor

                    @Instantiated private let editProfileViewControllerBuilder: Instantiator<EditProfileViewController>
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class EditProfileViewController: UIViewController {
                    public init(userVendor: UserVendor, userManager: UserManager, userNetworkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received private let userVendor: UserVendor
                    @Received private let userManager: UserManager
                    @Received private let userNetworkService: NetworkService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(userManager: UserManager) -> LoggedInViewController {
                        let userNetworkService: NetworkService = networkService
                        func __safeDI_profileViewControllerBuilder() -> ProfileViewController {
                            let userVendor: UserVendor = userManager
                            func __safeDI_editProfileViewControllerBuilder() -> EditProfileViewController {
                                EditProfileViewController(userVendor: userVendor, userManager: userManager, userNetworkService: userNetworkService)
                            }
                            let editProfileViewControllerBuilder = Instantiator<EditProfileViewController>(__safeDI_editProfileViewControllerBuilder)
                            return ProfileViewController(userVendor: userVendor, editProfileViewControllerBuilder: editProfileViewControllerBuilder)
                        }
                        let profileViewControllerBuilder = Instantiator<ProfileViewController>(__safeDI_profileViewControllerBuilder)
                        return LoggedInViewController(userManager: userManager, userNetworkService: userNetworkService, profileViewControllerBuilder: profileViewControllerBuilder)
                    }
                    let loggedInViewControllerBuilder = Instantiator<LoggedInViewController> {
                        __safeDI_loggedInViewControllerBuilder(userManager: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenReceivedPropertyIsAliasedWhenInstantiated() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService, renamedNetworkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User(username: username)
                    }

                    @Instantiated let networkService: NetworkService

                    @Received(fulfilledByDependencyNamed: "networkService", ofType: NetworkService.self, erasedToConcreteExistential: false) let renamedNetworkService: NetworkService
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService) {
                        self.authService = authService
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let authService: AuthService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    func __safeDI_authService() -> DefaultAuthService {
                        let networkService: NetworkService = DefaultNetworkService()
                        let renamedNetworkService: NetworkService = networkService
                        return DefaultAuthService(networkService: networkService, renamedNetworkService: renamedNetworkService)
                    }
                    let authService: AuthService = __safeDI_authService()
                    self.init(authService: authService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenReceivedPropertyIsAliasedTwice() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService, renamedNetworkService: NetworkService, renamedAgainNetworkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User(username: username)
                    }

                    @Received let networkService: NetworkService
                    @Received(fulfilledByDependencyNamed: "networkService", ofType: NetworkService.self) let renamedNetworkService: NetworkService

                    @Received(fulfilledByDependencyNamed: "renamedNetworkService", ofType: NetworkService.self) let renamedAgainNetworkService: NetworkService
                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService) {
                        self.authService = authService
                        self.networkService = networkService
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let authService: AuthService

                    @Instantiated let networkService: NetworkService
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    func __safeDI_authService() -> DefaultAuthService {
                        let renamedNetworkService: NetworkService = networkService
                        let renamedAgainNetworkService: NetworkService = renamedNetworkService
                        return DefaultAuthService(networkService: networkService, renamedNetworkService: renamedNetworkService, renamedAgainNetworkService: renamedAgainNetworkService)
                    }
                    let authService: AuthService = __safeDI_authService()
                    self.init(authService: authService, networkService: networkService)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenReceivedPropertyIsAliasedWhenForwarded() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol UserVendor {
                    var user: User { get }
                }

                public protocol UserManager: UserVendor {
                    var user: User { get set }
                }

                public final class DefaultUserManager: UserManager {
                    public init(user: User) {
                        self.user = user
                    }

                    public var user: User
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User(username: username)
                    }

                    @Received let networkService: NetworkService                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: Instantiator<LoggedInViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let authService: AuthService

                    @Instantiated let networkService: NetworkService

                    @Instantiated let loggedInViewControllerBuilder: Instantiator<LoggedInViewController>

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(UserManager(user: user))
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(userManager: UserManager, userVendor: UserVendor, profileViewControllerBuilder: Instantiator<ProfileViewController>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let userManager: UserManager

                    @Received(fulfilledByDependencyNamed: "userManager", ofType: UserManager.self) private let userVendor: UserVendor

                    @Instantiated private let profileViewControllerBuilder: Instantiator<ProfileViewController>
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class ProfileViewController: UIViewController {
                    public init(editProfileViewControllerBuilder: Instantiator<EditProfileViewController>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated private let editProfileViewControllerBuilder: Instantiator<EditProfileViewController>
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class EditProfileViewController: UIViewController {
                    public init(userVendor: UserVendor, userManager: UserManager) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received private let userVendor: UserVendor
                    @Received private let userManager: UserManager
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(userManager: UserManager) -> LoggedInViewController {
                        let userVendor: UserVendor = userManager
                        func __safeDI_profileViewControllerBuilder() -> ProfileViewController {
                            func __safeDI_editProfileViewControllerBuilder() -> EditProfileViewController {
                                EditProfileViewController(userVendor: userVendor, userManager: userManager)
                            }
                            let editProfileViewControllerBuilder = Instantiator<EditProfileViewController>(__safeDI_editProfileViewControllerBuilder)
                            return ProfileViewController(editProfileViewControllerBuilder: editProfileViewControllerBuilder)
                        }
                        let profileViewControllerBuilder = Instantiator<ProfileViewController>(__safeDI_profileViewControllerBuilder)
                        return LoggedInViewController(userManager: userManager, userVendor: userVendor, profileViewControllerBuilder: profileViewControllerBuilder)
                    }
                    let loggedInViewControllerBuilder = Instantiator<LoggedInViewController> {
                        __safeDI_loggedInViewControllerBuilder(userManager: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenReceivedPropertyIsAliasedWasALevelBelowWhereItWasForwarded() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public struct User {}
                """,
                """
                public protocol UserVendor {
                    var user: User { get }
                }

                public protocol UserManager: UserVendor {
                    var user: User { get set }
                }

                public final class DefaultUserManager: UserManager {
                    public init(user: User) {
                        self.user = user
                    }

                    public var user: User
                }
                """,
                """
                public protocol NetworkService {}

                @Instantiable(fulfillingAdditionalTypes: [NetworkService.self])
                public final class DefaultNetworkService: NetworkService {
                    public init() {}
                }
                """,
                """
                public protocol AuthService {
                    func login(username: String, password: String) async -> User
                }

                @Instantiable(fulfillingAdditionalTypes: [AuthService.self])
                public final class DefaultAuthService: AuthService {
                    public init(networkService: NetworkService) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public func login(username: String, password: String) async -> User {
                        User(username: username)
                    }

                    @Received let networkService: NetworkService                }
                """,
                """
                import UIKit

                @Instantiable(isRoot: true)
                public final class RootViewController: UIViewController {
                    public init(authService: AuthService, networkService: NetworkService, loggedInViewControllerBuilder: Instantiator<LoggedInViewController>) {
                        self.authService = authService
                        self.networkService = networkService
                        self.loggedInViewControllerBuilder = loggedInViewControllerBuilder
                        super.init(nibName: nil, bundle: nil)
                    }

                    @Instantiated let authService: AuthService

                    @Instantiated let networkService: NetworkService

                    @Instantiated let loggedInViewControllerBuilder: Instantiator<LoggedInViewController>

                    func login(username: String, password: String) {
                        Task { @MainActor in
                            let user = await authService.login(username: username, password: password)
                            let loggedInViewController = loggedInViewControllerBuilder.instantiate(UserManager(user: user))
                            pushViewController(loggedInViewController)
                        }
                    }
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class LoggedInViewController: UIViewController {
                    public init(userManager: UserManager, profileViewControllerBuilder: Instantiator<ProfileViewController>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Forwarded private let userManager: UserManager

                    @Instantiated private let profileViewControllerBuilder: Instantiator<ProfileViewController>
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class ProfileViewController: UIViewController {
                    public init(editProfileViewControllerBuilder: Instantiator<EditProfileViewController>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated private let editProfileViewControllerBuilder: Instantiator<EditProfileViewController>
                }
                """,
                """
                import UIKit

                @Instantiable
                public final class EditProfileViewController: UIViewController {
                    public init(userVendor: UserVendor, userManager: UserManager) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received(fulfilledByDependencyNamed: "userManager", ofType: UserManager.self) private let userVendor: UserVendor
                    @Received private let userManager: UserManager
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(UIKit)
            import UIKit
            #endif

            extension RootViewController {
                public convenience init() {
                    let networkService: NetworkService = DefaultNetworkService()
                    let authService: AuthService = DefaultAuthService(networkService: networkService)
                    func __safeDI_loggedInViewControllerBuilder(userManager: UserManager) -> LoggedInViewController {
                        func __safeDI_profileViewControllerBuilder() -> ProfileViewController {
                            func __safeDI_editProfileViewControllerBuilder() -> EditProfileViewController {
                                let userVendor: UserVendor = userManager
                                return EditProfileViewController(userVendor: userVendor, userManager: userManager)
                            }
                            let editProfileViewControllerBuilder = Instantiator<EditProfileViewController>(__safeDI_editProfileViewControllerBuilder)
                            return ProfileViewController(editProfileViewControllerBuilder: editProfileViewControllerBuilder)
                        }
                        let profileViewControllerBuilder = Instantiator<ProfileViewController>(__safeDI_profileViewControllerBuilder)
                        return LoggedInViewController(userManager: userManager, profileViewControllerBuilder: profileViewControllerBuilder)
                    }
                    let loggedInViewControllerBuilder = Instantiator<LoggedInViewController> {
                        __safeDI_loggedInViewControllerBuilder(userManager: $0)
                    }
                    self.init(authService: authService, networkService: networkService, loggedInViewControllerBuilder: loggedInViewControllerBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenFirstPropertyDependsOnLastPropertyAndMiddlePropertyHasNoDependencyEntanglementsWithEither() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
                """
                @Instantiable
                public final class Unrelated {
                    public init() {}
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init(grandchild: Grandchild, unrelated: Unrelated, greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let grandchild: Grandchild
                    @Instantiated let unrelated: Unrelated
                    @Instantiated let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class Grandchild {
                    public init(greatGrandchild: GreatGrandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let greatGrandchild: GreatGrandchild
                }
                """,
                """
                @Instantiable
                public final class GreatGrandchild {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let greatGrandchild = GreatGrandchild()
                        let grandchild = Grandchild(greatGrandchild: greatGrandchild)
                        let unrelated = Unrelated()
                        return Child(grandchild: grandchild, unrelated: unrelated, greatGrandchild: greatGrandchild)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootHasLotsOfDependenciesThatDependOnOneAnother() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(a: A, b: B, c: C, d: D, e: E, f: F, g: G, h: H, i: I, j: J, k: K, l: L, m: M, n: N, o: O, p: P, q: Q, r: R, s: S, t: T, u: U, v: V, w: W, x: X, y: Y, z: Z) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let a: A
                    @Instantiated let b: B
                    @Instantiated let c: C
                    @Instantiated let d: D
                    @Instantiated let e: E
                    @Instantiated let f: F
                    @Instantiated let g: G
                    @Instantiated let h: H
                    @Instantiated let i: I
                    @Instantiated let j: J
                    @Instantiated let k: K
                    @Instantiated let l: L
                    @Instantiated let m: M
                    @Instantiated let n: N
                    @Instantiated let o: O
                    @Instantiated let p: P
                    @Instantiated let q: Q
                    @Instantiated let r: R
                    @Instantiated let s: S
                    @Instantiated let t: T
                    @Instantiated let u: U
                    @Instantiated let v: V
                    @Instantiated let w: W
                    @Instantiated let x: X
                    @Instantiated let y: Y
                    @Instantiated let z: Z
                }
                """,
                """
                @Instantiable
                public final class A {
                    public init(x: X) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let x: X
                }
                """,
                """
                @Instantiable
                public final class B {
                    public init(a: A, d: D, t: T, o: O, y: Y, s: S) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let a: A
                    @Received let d: D
                    @Received let t: T
                    @Received let o: O
                    @Received let y: Y
                    @Received let s: S
                }
                """,
                """
                @Instantiable
                public final class C {
                    public init(u: U, n: N, y: Y) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let u: U
                    @Received let n: N
                    @Received let y: Y
                }
                """,
                """
                @Instantiable
                public final class D {
                    public init(o: O, g: G) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let o: O
                    @Received let g: G
                }
                """,
                """
                @Instantiable
                public final class E {
                    public init(g: G) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let g: G
                }
                """,
                """
                @Instantiable
                public final class F {
                    public init(a: A, x: X) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let a: A
                    @Received let x: X
                }
                """,
                """
                @Instantiable
                public final class G {
                    public init() {}
                }
                """,
                """
                @Instantiable
                public final class H {
                    public init(u: U, g: G) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let u: U
                    @Received let g: G
                }
                """,
                """
                @Instantiable
                public final class I {
                    public init(f: F) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let f: F
                }
                """,
                """
                @Instantiable
                public final class J {
                    public init(a: A, g: G) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let a: A
                    @Received let g: G
                }
                """,
                """
                @Instantiable
                public final class K {
                    public init(i: I, t: T) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let i: I
                    @Received let t: T
                }
                """,
                """
                @Instantiable
                public final class L {
                    public init(o: O, v: V, e: E) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let o: O
                    @Received let v: V
                    @Received let e: E
                }
                """,
                """
                @Instantiable
                public final class M {
                    public init(e: E) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let e: E
                }
                """,
                """
                @Instantiable
                public final class N {
                    public init(o: O, p: P, e: E) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let o: O
                    @Received let p: P
                    @Received let e: E
                }
                """,
                """
                @Instantiable
                public final class O {
                    public init(m: M, e: E, g: G, a: A) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let m: M
                    @Received let e: E
                    @Received let g: G
                    @Received let a: A
                }
                """,
                """
                @Instantiable
                public final class P {
                    public init(i: I, x: X) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let i: I
                    @Received let x: X
                }
                """,
                """
                @Instantiable
                public final class Q {
                    public init(u: U, t: T, e: E) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let u: U
                    @Received let t: T
                    @Received let e: E
                }
                """,
                """
                @Instantiable
                public final class R {
                    public init(a: A, m: M, o: O, n: N, e: E) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let a: A
                    @Received let m: M
                    @Received let o: O
                    @Received let n: N
                    @Received let e: E
                }
                """,
                """
                @Instantiable
                public final class S {
                    public init(a: A, t: T, o: O, r: R) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let a: A
                    @Received let t: T
                    @Received let o: O
                    @Received let r: R
                }
                """,
                """
                @Instantiable
                public final class T {
                    public init(e: E, n: N) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let e: E
                    @Received let n: N
                }
                """,
                """
                @Instantiable
                public final class U {
                    public init(p: P, d: D, o: O, w: W, n: N) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let p: P
                    @Received let d: D
                    @Received let o: O
                    @Received let w: W
                    @Received let n: N
                }
                """,
                """
                @Instantiable
                public final class V {
                    public init(a: A, t: T, o: O, f: F, c: C, i: I, d: D) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let a: A
                    @Received let t: T
                    @Received let o: O
                    @Received let f: F
                    @Received let c: C
                    @Received let i: I
                    @Received let d: D
                }
                """,
                """
                @Instantiable
                public final class W {
                    public init(a: A, x: X, o: O, n: N) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let a: A
                    @Received let x: X
                    @Received let o: O
                    @Received let n: N
                }
                """,
                """
                @Instantiable
                public final class X {
                    public init() {}
                }
                """,
                """
                @Instantiable
                public final class Y {
                    public init(u: U, p: P) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let u: U
                    @Received let p: P
                }
                """,
                """
                @Instantiable
                public final class Z {
                    public init(e: E, p: P, l: L, i: I, n: N) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Received let e: E
                    @Received let p: P
                    @Received let l: L
                    @Received let i: I
                    @Received let n: N
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    let x = X()
                    let a = A(x: x)
                    let g = G()
                    let e = E(g: g)
                    let m = M(e: e)
                    let o = O(m: m, e: e, g: g, a: a)
                    let d = D(o: o, g: g)
                    let f = F(a: a, x: x)
                    let i = I(f: f)
                    let p = P(i: i, x: x)
                    let n = N(o: o, p: p, e: e)
                    let r = R(a: a, m: m, o: o, n: n, e: e)
                    let t = T(e: e, n: n)
                    let s = S(a: a, t: t, o: o, r: r)
                    let w = W(a: a, x: x, o: o, n: n)
                    let u = U(p: p, d: d, o: o, w: w, n: n)
                    let y = Y(u: u, p: p)
                    let b = B(a: a, d: d, t: t, o: o, y: y, s: s)
                    let c = C(u: u, n: n, y: y)
                    let h = H(u: u, g: g)
                    let j = J(a: a, g: g)
                    let k = K(i: i, t: t)
                    let v = V(a: a, t: t, o: o, f: f, c: c, i: i, d: d)
                    let l = L(o: o, v: v, e: e)
                    let q = Q(u: u, t: t, e: e)
                    let z = Z(e: e, p: p, l: l, i: i, n: n)
                    self.init(a: a, b: b, c: c, d: d, e: e, f: f, g: g, h: h, i: i, j: j, k: k, l: l, m: m, n: n, o: o, p: p, q: q, r: r, s: s, t: t, u: u, v: v, w: w, x: x, y: y, z: z)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenRootPropertyWithOptionalInstantiator() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(childBuilder: Instantiator<Child>?) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let childBuilder: Instantiator<Child>?
                }
                """,
                """
                @Instantiable
                public final class Child {
                    public init() {}
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public convenience init() {
                    func __safeDI_childBuilder() -> Child {
                        Child()
                    }
                    let childBuilder: Instantiator<Child>? = Instantiator<Child>(__safeDI_childBuilder)
                    self.init(childBuilder: childBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenLazyInstantiationCycleExists() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(aBuilder: Instantiator<A>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let aBuilder: Instantiator<A>
                }
                """,
                """
                @Instantiable
                public struct A {
                    public init(bBuilder: Instantiator<B>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let bBuilder: Instantiator<B>
                }
                """,
                """
                @Instantiable
                public struct B {
                    public init(cBuilder: Instantiator<C>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let cBuilder: Instantiator<C>
                }
                """,
                """
                @Instantiable
                public struct C {
                    public init(aBuilder: Instantiator<A>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let aBuilder: Instantiator<A>
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public init() {
                    func __safeDI_aBuilder() -> A {
                        func __safeDI_bBuilder() -> B {
                            func __safeDI_cBuilder() -> C {
                                let aBuilder = Instantiator<A>(__safeDI_aBuilder)
                                return C(aBuilder: aBuilder)
                            }
                            let cBuilder = Instantiator<C>(__safeDI_cBuilder)
                            return B(cBuilder: cBuilder)
                        }
                        let bBuilder = Instantiator<B>(__safeDI_bBuilder)
                        return A(bBuilder: bBuilder)
                    }
                    let aBuilder = Instantiator<A>(__safeDI_aBuilder)
                    self.init(aBuilder: aBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenPartiallyLazyInstantiationCycleExists() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(a: A) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let a: A
                }
                """,
                """
                @Instantiable
                public struct A {
                    public init(b: B) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let b: B
                }
                """,
                """
                @Instantiable
                public struct B {
                    public init(cBuilder: Instantiator<C>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let cBuilder: Instantiator<C>
                }
                """,
                """
                @Instantiable
                public struct C {
                    public init(a: A) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let a: A
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public init() {
                    func __safeDI_a() -> A {
                        func __safeDI_b() -> B {
                            func __safeDI_cBuilder() -> C {
                                let a = A(b: b)
                                return C(a: a)
                            }
                            let cBuilder = Instantiator<C>(__safeDI_cBuilder)
                            return B(cBuilder: cBuilder)
                        }
                        let b: B = __safeDI_b()
                        return A(b: b)
                    }
                    let a: A = __safeDI_a()
                    self.init(a: a)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenLazySelfInstantiationCycleExists() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(a: A) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let a: A
                }
                """,
                """
                @Instantiable
                public struct A {
                    public init(aBuilder: Instantiator<A>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let aBuilder: Instantiator<A>
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public init() {
                    func __safeDI_a() -> A {
                        func __safeDI_aBuilder() -> A {
                            let aBuilder = Instantiator<A>(__safeDI_aBuilder)
                            return A(aBuilder: aBuilder)
                        }
                        let aBuilder = Instantiator<A>(__safeDI_aBuilder)
                        return A(aBuilder: aBuilder)
                    }
                    let a: A = __safeDI_a()
                    self.init(a: a)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenLazySelfForwardingInstantiationCycleExists() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(aBuilder: Instantiator<A>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let aBuilder: Instantiator<A>
                }
                """,
                """
                @Instantiable
                public struct A {
                    public init(aBuilder: Instantiator<A>, context: String) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let aBuilder: Instantiator<A>
                    @Forwarded let context: String
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public init() {
                    func __safeDI_aBuilder(context: String) -> A {
                        let aBuilder = Instantiator<A> {
                            __safeDI_aBuilder(context: $0)
                        }
                        return A(aBuilder: aBuilder, context: context)
                    }
                    let aBuilder = Instantiator<A> {
                        __safeDI_aBuilder(context: $0)
                    }
                    self.init(aBuilder: aBuilder)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenAGenericTypeIsAnExtendedInstantiableWithMultipleGenericReturnTypes() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(stringContainer: Container<String>, intContainer: Container<Int>, floatContainer: Container<Float>, voidContainer: Container<Void>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let stringContainer: Container<String>
                    @Instantiated let intContainer: Container<Int>
                    @Instantiated let floatContainer: Container<Float>
                    @Instantiated let voidContainer: Container<Void>
                }
                """,
                """
                public struct Container<T> {
                    let value: T
                }
                @Instantiable
                extension Container: Instantiable {
                    public static func instantiate() -> Container<String> {
                        .init(value: "")
                    }
                    public static func instantiate() -> Container<Int> {
                        .init(value: 0)
                    }
                    public static func instantiate() -> Container<Float> {
                        .init(value: 0)
                    }
                    public static func instantiate() -> Container<Void> {
                        .init(value: ())
                    }
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public init() {
                    let stringContainer: Container<String> = Container<String>.instantiate()
                    let intContainer: Container<Int> = Container<Int>.instantiate()
                    let floatContainer: Container<Float> = Container<Float>.instantiate()
                    let voidContainer: Container<Void> = Container<Void>.instantiate()
                    self.init(stringContainer: stringContainer, intContainer: intContainer, floatContainer: floatContainer, voidContainer: voidContainer)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenAGenericTypeIsAnExtendedInstantiableWithMultipleGenericFullyQualifiedReturnTypes() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                @Instantiable(isRoot: true)
                public struct Root {
                    public init(stringContainer: MyModule.Container<String>, intContainer: MyModule.Container<Int>, floatContainer: MyModule.Container<Float>, voidContainer: MyModule.Container<Void>) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let stringContainer: MyModule.Container<String>
                    @Instantiated let intContainer: MyModule.Container<Int>
                    @Instantiated let floatContainer: MyModule.Container<Float>
                    @Instantiated let voidContainer: MyModule.Container<Void>
                }
                """,
                """
                public struct Container<T> {
                    let value: T
                }
                @Instantiable
                extension MyModule.Container: Instantiable {
                    public static func instantiate() -> MyModule.Container<String> {
                        .init(value: "")
                    }
                    public static func instantiate() -> MyModule.Container<Int> {
                        .init(value: 0)
                    }
                    public static func instantiate() -> MyModule.Container<Float> {
                        .init(value: 0)
                    }
                    public static func instantiate() -> MyModule.Container<Void> {
                        .init(value: ())
                    }
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension Root {
                public init() {
                    let stringContainer: MyModule.Container<String> = MyModule.Container<String>.instantiate()
                    let intContainer: MyModule.Container<Int> = MyModule.Container<Int>.instantiate()
                    let floatContainer: MyModule.Container<Float> = MyModule.Container<Float>.instantiate()
                    let voidContainer: MyModule.Container<Void> = MyModule.Container<Void>.instantiate()
                    self.init(stringContainer: stringContainer, intContainer: intContainer, floatContainer: floatContainer, voidContainer: voidContainer)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenTreeContainsNestedType() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                @Instantiable
                public final class Child {
                    public init(inner: Inner) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiable
                    public final class Inner {
                        public init() {}
                    }

                    @Instantiated private let inner: Inner
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let inner = Child.Inner()
                        return Child(inner: inner)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenTreeContainsNestedTypesWithNoQualification() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                @Instantiable
                public final class Child {
                    public init(grandchild: Grandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiable
                    public final class Grandchild {
                        public init(greatGrandchild: GreatGrandchild, pathalogical: Pathalogical) {
                            fatalError("SafeDI doesn't inspect the initializer body")
                        }

                        @Instantiated let greatGrandchild: GreatGrandchild
                        @Instantiated let pathalogical: Pathalogical

                        @Instantiable
                        public final class GreatGrandchild {
                            public init(pathalogical: Pathalogical) {
                                fatalError("SafeDI doesn't inspect the initializer body")
                            }

                            @Instantiated let pathalogical: Pathalogical

                            @Instantiable
                            public final class Pathalogical {
                                public init() {}
                            }
                        }

                        @Instantiable
                        public final class Pathalogical {
                            public init() {}
                        }
                    }

                    @Instantiated private let grandchild: Grandchild
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        func __safeDI_grandchild() -> Child.Grandchild {
                            func __safeDI_greatGrandchild() -> Child.Grandchild.GreatGrandchild {
                                let pathalogical = Child.Grandchild.GreatGrandchild.Pathalogical()
                                return Child.Grandchild.GreatGrandchild(pathalogical: pathalogical)
                            }
                            let greatGrandchild: Child.Grandchild.GreatGrandchild = __safeDI_greatGrandchild()
                            let pathalogical = Child.Grandchild.Pathalogical()
                            return Child.Grandchild(greatGrandchild: greatGrandchild, pathalogical: pathalogical)
                        }
                        let grandchild: Child.Grandchild = __safeDI_grandchild()
                        return Child(grandchild: grandchild)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenTreeContainsNestedTypesWithMixedQualification() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                @Instantiable
                public final class Child {
                    public init(grandchild: Grandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiable
                    public final class Grandchild {
                        public init(greatGrandchild: GreatGrandchild, pathalogical: Grandchild.Pathalogical) {
                            fatalError("SafeDI doesn't inspect the initializer body")
                        }

                        @Instantiated let greatGrandchild: GreatGrandchild
                        @Instantiated let pathalogical: Grandchild.Pathalogical

                        @Instantiable
                        public final class GreatGrandchild {
                            public init(pathalogical: Child.Grandchild.GreatGrandchild.Pathalogical) {
                                fatalError("SafeDI doesn't inspect the initializer body")
                            }

                            @Instantiated let pathalogical: Child.Grandchild.GreatGrandchild.Pathalogical

                            @Instantiable
                            public final class Pathalogical {
                                public init() {}
                            }
                        }

                        @Instantiable
                        public final class Pathalogical {
                            public init() {}
                        }
                    }

                    @Instantiated private let grandchild: Grandchild
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        func __safeDI_grandchild() -> Child.Grandchild {
                            func __safeDI_greatGrandchild() -> Child.Grandchild.GreatGrandchild {
                                let pathalogical = Child.Grandchild.GreatGrandchild.Pathalogical()
                                return Child.Grandchild.GreatGrandchild(pathalogical: pathalogical)
                            }
                            let greatGrandchild: Child.Grandchild.GreatGrandchild = __safeDI_greatGrandchild()
                            let pathalogical = Child.Grandchild.Pathalogical()
                            return Child.Grandchild(greatGrandchild: greatGrandchild, pathalogical: pathalogical)
                        }
                        let grandchild: Child.Grandchild = __safeDI_grandchild()
                        return Child(grandchild: grandchild)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenTreeContainsNestedTypesWithSameObjectReferencedWithDifferingQualification() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                @Instantiable
                public final class Child {
                    public init(pathalogical: Child.Grandchild.Pathalogical, grandchild: Grandchild) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }
                    @Instantiated let pathalogical: Child.Grandchild.Pathalogical

                    @Instantiable
                    public final class Grandchild {
                        public init(greatGrandchild: GreatGrandchild, pathalogical: Pathalogical) {
                            fatalError("SafeDI doesn't inspect the initializer body")
                        }

                        @Instantiated let greatGrandchild: GreatGrandchild
                        @Received let pathalogical: Pathalogical

                        @Instantiable
                        public final class GreatGrandchild {
                            public init(pathalogical: Grandchild.Pathalogical) {
                                fatalError("SafeDI doesn't inspect the initializer body")
                            }

                            @Received let pathalogical: Grandchild.Pathalogical

                            @Instantiable
                            public final class Pathalogical {
                                public init() {}
                            }
                        }

                        @Instantiable
                        public final class Pathalogical {
                            public init() {}
                        }
                    }

                    @Instantiated private let grandchild: Grandchild
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let pathalogical = Child.Grandchild.Pathalogical()
                        func __safeDI_grandchild() -> Child.Grandchild {
                            let greatGrandchild = Child.Grandchild.GreatGrandchild(pathalogical: pathalogical)
                            return Child.Grandchild(greatGrandchild: greatGrandchild, pathalogical: pathalogical)
                        }
                        let grandchild: Child.Grandchild = __safeDI_grandchild()
                        return Child(pathalogical: pathalogical, grandchild: grandchild)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenTreeContainsNestedTypeFulfillingAdditionalNestedTypes() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                @Instantiable
                public final class Child {
                    public init(inner: Inner) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public protocol Inner {}

                    @Instantiable(fulfillingAdditionalTypes: [Inner.self])
                    public final class DefaultInner: Inner {
                        public init() {}
                    }

                    @Instantiated private let inner: Inner
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let inner: Inner = Child.DefaultInner()
                        return Child(inner: inner)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    @MainActor
    func test_run_writesConvenienceExtensionOnRootOfTree_whenTreeContainsNestedTypeFulfillingAdditionalFullyQualifiedNestedTypes() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                import Foundation

                @Instantiable
                public final class Child {
                    public init(inner: Inner) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    public protocol Inner {}

                    @Instantiable(fulfillingAdditionalTypes: [Child.Inner.self])
                    public final class DefaultInner: Inner {
                        public init() {}
                    }

                    @Instantiated private let inner: Inner
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class Root {
                    public init(child: Child) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated let child: Child
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            #if canImport(Foundation)
            import Foundation
            #endif

            extension Root {
                public convenience init() {
                    func __safeDI_child() -> Child {
                        let inner: Child.Inner = Child.DefaultInner()
                        return Child(inner: inner)
                    }
                    let child: Child = __safeDI_child()
                    self.init(child: child)
                }
            }
            """
        )
    }

    func test_run_writesConvenienceExtensionOnRootOfTree_whenTypeIsFulfilledByNestedType() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                public protocol ErasedType {}

                public final class EnclosingType {
                    @Instantiable
                    public final class SomeType: ErasedType {
                        public init() {}
                    }
                }
                """,
                """
                @Instantiable(isRoot: true)
                public final class TypeWithDependency {
                    public init(erasedType: ErasedType ) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated(fulfilledByType: "EnclosingType.SomeType") let erasedType: ErasedType 
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension TypeWithDependency {
                public convenience init() {
                    let erasedType: ErasedType = EnclosingType.SomeType()
                    self.init(erasedType: erasedType)
                }
            }
            """
        )
    }

    func test_run_writesConvenienceExtensionOnRootOfTree_whenTypeIsFulfilledByNestedTypeAndExtensionIsDefinedFirst() async throws {
        let output = try await executeSafeDIToolTest(
            swiftFileContent: [
                """
                extension ErasedType {
                    // Extension defined before an @Instantiable should not make a difference.
                }

                public protocol ErasedType {}

                public final class EnclosingType {
                    @Instantiable
                    public final class SomeType: ErasedType {
                        public init() {}
                    }
                }
                """,
                """
                extension ErasedType {
                    // Extension defined before an @Instantiable should not make a difference.
                }

                @Instantiable(isRoot: true)
                public final class TypeWithDependency {
                    public init(erasedType: ErasedType ) {
                        fatalError("SafeDI doesn't inspect the initializer body")
                    }

                    @Instantiated(fulfilledByType: "EnclosingType.SomeType") let erasedType: ErasedType 
                }
                """,
            ],
            buildDependencyTreeOutput: true,
            filesToDelete: &filesToDelete
        )

        XCTAssertEqual(
            try XCTUnwrap(output.dependencyTree),
            """
            // This file was generated by the SafeDIGenerateDependencyTree build tool plugin.
            // Any modifications made to this file will be overwritten on subsequent builds.
            // Please refrain from editing this file directly.

            extension TypeWithDependency {
                public convenience init() {
                    let erasedType: ErasedType = EnclosingType.SomeType()
                    self.init(erasedType: erasedType)
                }
            }
            """
        )
    }

    // MARK: Private

    private var filesToDelete = [URL]()
}
